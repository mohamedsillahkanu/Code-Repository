<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">   
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Repository</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0066cc 0%, #004499 50%, #ffffff 100%);
            min-height: 100vh;
            color: #333;
            padding: 0;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #0066cc;
            padding: 25px 0;
            margin-bottom: 40px;
            box-shadow: 0 2px 10px rgba(0, 102, 204, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 30px;
        }

        .logo-container {
            width: 140px;
            height: 90px;
            border: 2px solid #0066cc;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.15);
            transition: transform 0.3s ease;
        }

        .logo-container:hover {
            transform: translateY(-3px);
        }

        .logo-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 8px;
        }

        .title-section {
            text-align: center;
        }

        .main-title {
            font-size: 3em;
            color: #0066cc;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0, 102, 204, 0.3);
        }

        .subtitle {
            font-size: 1.4em;
            color: #004499;
            font-weight: 400;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 15px 40px rgba(0, 102, 204, 0.2);
            border: 1px solid rgba(0, 102, 204, 0.2);
        }

        /* Tab Toggle Button */
        .tab-toggle-btn {
            background: linear-gradient(135deg, #004499, #0066cc);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 68, 153, 0.3);
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            width: 250px;
        }

        .tab-toggle-btn:hover {
            background: linear-gradient(135deg, #0066cc, #004499);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4);
        }

        .tab-toggle-btn .arrow {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .tab-toggle-btn.collapsed .arrow {
            transform: rotate(-90deg);
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 3px solid #0066cc;
            margin-bottom: 40px;
            gap: 5px;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.5s ease;
        }

        .tab-navigation.expanded {
            max-height: 200px;
            opacity: 1;
            margin-bottom: 40px;
        }

        .tab-button {
            background: rgba(0, 102, 204, 0.1);
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #004499;
            border-radius: 10px 10px 0 0;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            margin-bottom: -3px;
            position: relative;
        }

        .tab-button:hover {
            background: rgba(0, 102, 204, 0.2);
            color: #0066cc;
        }

        .tab-button.active {
            background: #0066cc;
            color: white;
            border-bottom: 3px solid #0066cc;
            transform: translateY(3px);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Content Sections */
        .section-header {
            color: #0066cc;
            font-size: 2.2em;
            font-weight: 700;
            margin-bottom: 30px;
            text-align: center;
            padding: 20px;
            background: rgba(0, 102, 204, 0.1);
            border-radius: 15px;
            border-left: 5px solid #0066cc;
        }

        /* Hierarchical Section Styling */
        .collapsible-section {
            margin-bottom: 30px;
            border: 2px solid rgba(0, 102, 204, 0.2);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 102, 204, 0.1);
        }

        /* Level 2 sections (##) - Main sections */
        .section-toggle.level-2 {
            background: linear-gradient(135deg, #0066cc, #004499);
            color: white;
            border: none;
            padding: 20px;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 1.3em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-toggle.level-2:hover {
            background: linear-gradient(135deg, #004499, #0066cc);
        }

        /* Level 3 sections (###) - Subsections */
        .subsection {
            border-left: 4px solid #3b82f6;
            margin: 15px 0;
            border-radius: 0 10px 10px 0;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        .section-toggle.level-3 {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            border: none;
            padding: 15px 20px;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-toggle.level-3:hover {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
        }

        /* Level 4 sections (####) - Sub-subsections */
        .sub-subsection {
            border-left: 4px solid #10b981;
            margin: 10px 0 10px 20px;
            border-radius: 0 8px 8px 0;
            box-shadow: 0 1px 6px rgba(16, 185, 129, 0.1);
        }

        .section-toggle.level-4 {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px 15px;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-toggle.level-4:hover {
            background: linear-gradient(135deg, #059669, #10b981);
        }

        /* Common toggle arrow styling */
        .section-toggle::after {
            content: 'â–¼';
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .section-toggle.collapsed::after {
            transform: rotate(-90deg);
        }

        .section-content {
            background: rgba(255, 255, 255, 0.95);
            max-height: 0;
            overflow: hidden;
            transition: all 0.5s ease;
            padding: 0;
        }

        .section-content.expanded {
            max-height: none;
            padding: 20px;
        }

        /* Nested content styling */
        .section-content.level-3.expanded,
        .section-content.level-4.expanded {
            padding: 15px;
        }

        .content-text {
            font-size: 1.1em;
            line-height: 1.6;
            color: #333;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            border-left: 4px solid #0066cc;
        }

        /* Nested content text styling */
        .content-text.level-3 {
            border-left-color: #3b82f6;
            padding: 15px;
            margin-bottom: 15px;
        }

        .content-text.level-4 {
            border-left-color: #10b981;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 1em;
        }

        /* Image styling within content */
        .content-text img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.2);
            margin: 15px 0;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        /* Step Description */
        .step-description {
            background: rgba(0, 102, 204, 0.05);
            border-left: 4px solid #0066cc;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 0 10px 10px 0;
            color: #004499;
            font-size: 1em;
            line-height: 1.5;
            font-weight: 500;
        }

        /* Code Section Styling */
        .code-section {
            margin: 30px 0;
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.1);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .code-header {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .code-title {
            font-weight: 600;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .copy-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .copy-btn.copied {
            background: #10b981;
            border-color: #10b981;
        }

        .code-container {
            background: #1e293b;
            padding: 0;
            position: relative;
            overflow-x: auto;
        }

        .code-content {
            padding: 25px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #e2e8f0;
            white-space: pre;
            overflow-x: auto;
        }

        /* Loading indicator */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #0066cc;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #0066cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .main-title {
                font-size: 2.2em;
            }
            
            .subtitle {
                font-size: 1.2em;
            }
            
            .logo-section {
                justify-content: center;
            }
            
            .logo-container {
                width: 120px;
                height: 80px;
            }
            
            .dashboard-container {
                padding: 30px;
            }

            .tab-navigation {
                flex-direction: column;
            }

            .tab-button {
                border-radius: 10px;
                margin-bottom: 5px;
                padding: 12px 20px;
                font-size: 0.9em;
            }

            .tab-button.active {
                transform: none;
            }

            .tab-toggle-btn {
                width: 200px;
                padding: 12px 20px;
                font-size: 1em;
            }

            .section-toggle {
                font-size: 1.1em !important;
                padding: 15px !important;
            }

            .sub-subsection {
                margin-left: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <!-- Logo Section for 5 logos -->
            <div class="logo-section">
                <div class="logo-container">
                    <img src="NMCP.png" alt="NMCP Logo" class="logo-image">
                </div>
                
                <div class="logo-container">
                    <img src="WHO.png" alt="WHO Logo" class="logo-image">
                </div>
                
                <div class="logo-container">
                    <img src="CHAI2.png" alt="CHAI Logo" class="logo-image">
                </div>

                 <div class="logo-container">
                    <img src="NU logo.png" alt="NU Logo" class="logo-image">
                </div>

                <div class="logo-container">
                    <img src="ICF-SL.jpg" alt="ICF-SL Logo" class="logo-image">
                </div>
            </div>
            
            <!-- Title Section -->
            <div class="title-section">
                <h1 class="main-title">MTR Code Repository</h1>
                <h2 class="subtitle">2021-2024</h2>
            </div>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Tab Toggle Button -->
        <button class="tab-toggle-btn collapsed" onclick="toggleTabs()" id="tabToggleBtn">
            <span>ðŸ“‚</span>
            <span>Show Navigation Menu</span>
            <span class="arrow">â–¼</span>
        </button>

        <!-- Dynamic Tab Navigation - Will be populated by JavaScript -->
        <div class="tab-navigation" id="tabNavigation">
            <!-- Tabs will be generated dynamically from tab_config.json -->
        </div>

        <!-- Tab Contents -->
        <div id="overview" class="tab-content active">
            <div class="section-header">Code Repository</div>
            
            <!-- Code Repository Introduction -->
            <div class="collapsible-section">
                <button class="section-toggle level-2 collapsed" onclick="toggleSection(this)">
                    ðŸ’» Code Repository Overview
                </button>
                <div class="section-content">
                    <div class="content-text">
                        <strong>Malaria Data Analysis Code Repository</strong><br>
                        This system provides a comprehensive collection of Python scripts and analysis tools designed specifically for the National Malaria Control Programme (NMCP) in Sierra Leone. 
                        The code repository contains standardized functions for processing malaria surveillance data, calculating key indicators, and generating analytical reports that support evidence-based decision making.
                    </div>
                </div>
            </div>
        </div>

        <!-- Dynamic Tab Contents will be populated here -->
        <div id="tab2" class="tab-content">
            <div class="section-header">Malaria Analysis Code</div>
            <div class="loading" id="loading-tab2">
                <div class="spinner"></div>
                Loading content...
            </div>
        </div>

        <div id="tab3" class="tab-content">
            <div class="section-header">Data Visualization</div>
            <div class="loading" id="loading-tab3">
                <div class="spinner"></div>
                Loading content...
            </div>
        </div>

        <div id="tab4" class="tab-content">
            <div class="section-header">Reports & Export</div>
            <div class="loading" id="loading-tab4">
                <div class="spinner"></div>
                Loading content...
            </div>
        </div>
    </div>

    <script>
        // Dynamic Tab Configuration System - Load from external config file
        let TAB_CONFIG = {};
        let dynamicTabs = [];

        // Load configuration from external JSON file
        async function loadTabConfiguration() {
            try {
                const response = await fetch('tab_config.json');
                if (response.ok) {
                    const config = await response.json();
                    TAB_CONFIG = config.tabs || {};
                    dynamicTabs = config.navigation || [];
                    
                    // Generate navigation dynamically
                    generateDynamicNavigation();
                    
                    console.log('âœ… Tab configuration loaded successfully');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.warn('âš ï¸ Could not load tab_config.json, using default configuration');
                console.warn('ðŸ“ Create tab_config.json file to customize tabs and files');
                
                // Fallback to default configuration
                loadDefaultConfiguration();
                return false;
            }
        }

        // Default configuration if tab_config.json is not found
        function loadDefaultConfiguration() {
            TAB_CONFIG = {
                'tab2': { file: 'malaria_analysis.md', title: 'Malaria Analysis Code' },
                'tab3': { file: 'data_visualization.md', title: 'Data Visualization' },
                'tab4': { file: 'reports_export.md', title: 'Reports & Export' }
            };
            
            dynamicTabs = [
                { id: 'overview', title: 'Overview', default: true },
                { id: 'tab2', title: 'Malaria Analysis Code' },
                { id: 'tab3', title: 'Data Visualization' },
                { id: 'tab4', title: 'Reports & Export' }
            ];
            
            generateDynamicNavigation();
        }

        // Generate navigation tabs dynamically
        function generateDynamicNavigation() {
            const tabNavigation = document.getElementById('tabNavigation');
            if (!tabNavigation) return;
            
            // Clear existing tabs
            tabNavigation.innerHTML = '';
            
            // Generate tabs from configuration
            dynamicTabs.forEach((tab, index) => {
                const button = document.createElement('button');
                button.className = `tab-button ${tab.default ? 'active' : ''}`;
                button.onclick = (event) => openTab(event, tab.id);
                button.textContent = tab.title;
                tabNavigation.appendChild(button);
                
                // Create tab content container if it doesn't exist (except overview)
                if (tab.id !== 'overview' && !document.getElementById(tab.id)) {
                    createTabContainer(tab.id, tab.title);
                }
            });
        }

        // Create tab content container
        function createTabContainer(tabId, title) {
            const dashboardContainer = document.querySelector('.dashboard-container');
            if (!dashboardContainer) return;
            
            const tabDiv = document.createElement('div');
            tabDiv.id = tabId;
            tabDiv.className = 'tab-content';
            tabDiv.innerHTML = `
                <div class="section-header">${title}</div>
                <div class="loading" id="loading-${tabId}">
                    <div class="spinner"></div>
                    Loading content...
                </div>
            `;
            
            dashboardContainer.appendChild(tabDiv);
        }

        function openTab(evt, tabName) {
            // Hide all tab contents
            var tabcontents = document.getElementsByClassName("tab-content");
            for (var i = 0; i < tabcontents.length; i++) {
                tabcontents[i].classList.remove("active");
            }
            
            // Remove active class from all tab buttons
            var tabbuttons = document.getElementsByClassName("tab-button");
            for (var i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].classList.remove("active");
            }
            
            // Show the selected tab content and mark button as active
            var targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add("active");
            }
            if (evt && evt.currentTarget) {
                evt.currentTarget.classList.add("active");
            }
            
            // Load content if not already loaded
            if (TAB_CONFIG[tabName] && !targetTab.dataset.loaded) {
                loadTabContent(tabName);
            }
            
            // Auto-collapse navigation after tab selection
            var tabNav = document.getElementById("tabNavigation");
            var toggleBtn = document.getElementById("tabToggleBtn");
            if (tabNav && toggleBtn) {
                tabNav.classList.remove("expanded");
                toggleBtn.classList.add("collapsed");
                toggleBtn.innerHTML = '<span>ðŸ“‚</span><span>Show Navigation Menu</span><span class="arrow">â–¼</span>';
            }
        }

        function toggleTabs() {
            var tabNav = document.getElementById("tabNavigation");
            var toggleBtn = document.getElementById("tabToggleBtn");
            
            if (tabNav && toggleBtn) {
                if (tabNav.classList.contains("expanded")) {
                    // Collapse the menu
                    tabNav.classList.remove("expanded");
                    toggleBtn.classList.add("collapsed");
                    toggleBtn.innerHTML = '<span>ðŸ“‚</span><span>Show Navigation Menu</span><span class="arrow">â–¼</span>';
                } else {
                    // Expand the menu
                    tabNav.classList.add("expanded");
                    toggleBtn.classList.remove("collapsed");
                    toggleBtn.innerHTML = '<span>ðŸ“‚</span><span>Hide Navigation Menu</span><span class="arrow">â–¼</span>';
                }
            }
        }

        function toggleSection(button) {
            if (!button || !button.nextElementSibling) return;
            
            var content = button.nextElementSibling;
            var isCollapsed = content.classList.contains("expanded");
            
            if (isCollapsed) {
                content.classList.remove("expanded");
                button.classList.add("collapsed");
            } else {
                content.classList.add("expanded");
                button.classList.remove("collapsed");
            }
        }

        function copyCode(elementId) {
            const codeContent = document.getElementById(elementId);
            if (!codeContent) return;
            
            // Find the copy button (next button in the code header)
            const codeSection = codeContent.closest('.code-section');
            const copyBtn = codeSection ? codeSection.querySelector('.copy-btn') : null;
            if (!copyBtn) return;
            
            // Get the text content without HTML tags
            const textContent = codeContent.innerText || codeContent.textContent;
            
            // Copy to clipboard
            navigator.clipboard.writeText(textContent).then(function() {
                // Change button appearance
                const originalHTML = copyBtn.innerHTML;
                copyBtn.innerHTML = '<span>âœ…</span> Copied!';
                copyBtn.classList.add('copied');
                
                // Reset button after 2 seconds
                setTimeout(function() {
                    copyBtn.innerHTML = originalHTML;
                    copyBtn.classList.remove('copied');
                }, 2000);
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = textContent;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                
                const originalHTML = copyBtn.innerHTML;
                copyBtn.innerHTML = '<span>âœ…</span> Copied!';
                copyBtn.classList.add('copied');
                
                setTimeout(function() {
                    copyBtn.innerHTML = originalHTML;
                    copyBtn.classList.remove('copied');
                }, 2000);
            });
        }

        // Load markdown content from file
        async function loadTabContent(tabName) {
            const config = TAB_CONFIG[tabName];
            if (!config) return;

            const tabElement = document.getElementById(tabName);
            const loadingElement = document.getElementById(`loading-${tabName}`);
            
            try {
                // Show loading
                if (loadingElement) {
                    loadingElement.style.display = 'flex';
                }

                const response = await fetch(config.file);
                if (!response.ok) {
                    throw new Error(`Failed to load ${config.file}: ${response.status}`);
                }
                
                const markdown = await response.text();
                const sections = parseMarkdownHierarchical(markdown);
                
                // Render sections hierarchically
                const renderedSections = renderHierarchicalSections(sections);
                
                // Update tab content
                if (tabElement) {
                    const header = tabElement.querySelector('.section-header').outerHTML;
                    tabElement.innerHTML = header + renderedSections;
                }
                
                // Mark as loaded
                tabElement.dataset.loaded = 'true';
                
            } catch (error) {
                console.error('Error loading tab content:', error);
                // Show error message
                if (tabElement) {
                    const header = tabElement.querySelector('.section-header').outerHTML;
                    tabElement.innerHTML = header + `
                        <div class="content-text" style="color: #dc2626; border-left-color: #dc2626;">
                            <strong>Error loading content:</strong><br>
                            Could not load ${config.file}. Please ensure the file exists in the main repository directory.
                            <br><br>
                            <em>Expected files in main repo:</em><br>
                            - malaria_analysis.md<br>
                            - data_visualization.md<br>
                            - reports_export.md
                            <br><br>
                            <em>Current attempt:</em> Trying to load "${config.file}"
                        </div>
                    `;
                }
            } finally {
                // Hide loading
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
            }
        }

        // Enhanced markdown parsing for hierarchical structure
        function parseMarkdownHierarchical(markdown) {
            const sections = [];
            const lines = markdown.split('\n');
            let currentSection = null;
            let currentContent = [];

            for (let line of lines) {
                // Check for headers at different levels
                const headerMatch = line.match(/^(#{2,4})\s+(.+)$/);
                
                if (headerMatch) {
                    // Save previous section if exists
                    if (currentSection) {
                        currentSection.content = currentContent.join('\n').trim();
                        sections.push(currentSection);
                    }
                    
                    // Start new section
                    const level = headerMatch[1].length;
                    const title = headerMatch[2].trim();
                    
                    currentSection = {
                        level: level,
                        title: title,
                        content: '',
                        id: `section_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                    };
                    currentContent = [];
                } else {
                    currentContent.push(line);
                }
            }

            // Add last section
            if (currentSection) {
                currentSection.content = currentContent.join('\n').trim();
                sections.push(currentSection);
            }

            return sections;
        }

        // Render hierarchical sections
        function renderHierarchicalSections(sections) {
            let html = '';
            let openContainers = [];
            
            for (let i = 0; i < sections.length; i++) {
                const section = sections[i];
                const nextSection = sections[i + 1];
                
                // Close containers if next section is at same or higher level
                if (nextSection && nextSection.level <= section.level) {
                    while (openContainers.length > 0 && openContainers[openContainers.length - 1].level >= nextSection.level) {
                        const container = openContainers.pop();
                        html += '</div></div>'; // Close section-content and collapsible-section
                    }
                }
                
                // Determine container class and styling based on level
                let containerClass = 'collapsible-section';
                let toggleClass = `section-toggle level-${section.level} collapsed`;
                let contentClass = `section-content level-${section.level}`;
                let textClass = `content-text level-${section.level}`;
                
                if (section.level === 3) {
                    containerClass += ' subsection';
                } else if (section.level === 4) {
                    containerClass += ' sub-subsection';
                }
                
                // Process the content
                const processedContent = renderSectionContent(section.content, section.level);
                
                // Generate section HTML
                html += `
                    <div class="${containerClass}">
                        <button class="${toggleClass}" onclick="toggleSection(this)">
                            ${getSectionIcon(section.level)} ${section.title}
                        </button>
                        <div class="${contentClass}">
                            <div class="${textClass}">
                                ${processedContent}
                            </div>
                `;
                
                // Track open containers
                openContainers.push({
                    level: section.level,
                    id: section.id
                });
                
                // If this is the last section or next section is at higher level, close containers
                if (!nextSection || nextSection.level <= section.level) {
                    while (openContainers.length > 0) {
                        openContainers.pop();
                        html += '</div></div>'; // Close section-content and collapsible-section
                    }
                }
            }
            
            return html;
        }

        // Get appropriate icon for section level
        function getSectionIcon(level) {
            const icons = {
                2: 'ðŸ“',
                3: 'ðŸ“‚',
                4: 'ðŸ“„'
            };
            return icons[level] || 'ðŸ“‹';
        }

        // Render section content with markdown processing
        function renderSectionContent(content, level) {
            const codeBlocks = [];
            let processedContent = content;
            
            // Extract and replace code blocks
            processedContent = processedContent.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, language, code) => {
                const codeId = `code_${Date.now()}_${codeBlocks.length}`;
                codeBlocks.push({ id: codeId, language: language || 'python', code: code.trim() });
                return `__CODE_BLOCK_${codeBlocks.length - 1}__`;
            });

            // Process other markdown - escape HTML entities in regular content first
            processedContent = processedContent
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Process markdown syntax (after escaping HTML)
            processedContent = processedContent
                .replace(/!\[(.*?)\]\((.*?)\)/g, '<img src="$2" alt="$1" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,102,204,0.2); margin: 15px 0;">')
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #0066cc; text-decoration: underline;">$1</a>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code style="background: rgba(0,102,204,0.1); padding: 2px 4px; border-radius: 3px;">$1</code>')
                .replace(/^\- (.+)$/gm, '<li>$1</li>')
                .replace(/^\d+\.\s(.+)$/gm, '<li>$1</li>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/^(.+)$/gm, '<p>$1</p>');

            // Wrap lists
            processedContent = processedContent.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                .replace(/<\/p><p><ul>/g, '<ul>')
                .replace(/<\/ul><\/p><p>/g, '</ul>');

            // Replace code blocks with properly formatted HTML
            codeBlocks.forEach((block, idx) => {
                const formattedCode = formatCodeBlock(block.code, block.language);
                const codeHtml = `
                    <div class="code-section">
                        <div class="code-header">
                            <div class="code-title">
                                <span>ðŸ’»</span>
                                ${block.language.toUpperCase()} Code
                            </div>
                            <button class="copy-btn" onclick="copyCode('${block.id}')">
                                <span>ðŸ“‹</span>
                                Copy Code
                            </button>
                        </div>
                        <div class="code-container">
                            <div class="code-content" id="${block.id}">${formattedCode}</div>
                        </div>
                    </div>
                `;
                processedContent = processedContent.replace(`__CODE_BLOCK_${idx}__`, codeHtml);
            });

            return processedContent;
        }

        // Enhanced code formatting with syntax highlighting
        function formatCodeBlock(code, language = '') {
            // Escape HTML entities first
            let escaped = code
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
            
            // Apply syntax highlighting for Python or general code
            if (language === 'python' || language === 'py' || language === '') {
                return applySyntaxHighlighting(escaped);
            }
            
            return escaped;
        }

        // Enhanced syntax highlighting with better color scheme
        function applySyntaxHighlighting(code) {
            let result = '';
            const lines = code.split('\n');
            
            lines.forEach((line, lineIndex) => {
                const trimmedLine = line.trim();
                
                // Full line comments (lines starting with #)
                if (trimmedLine.startsWith('#')) {
                    result += `<span style="color: #6a9955; font-style: italic; font-weight: 500;">${line}</span>`;
                } else {
                    // Process line word by word for syntax highlighting
                    const words = line.split(/(\s+)/);
                    
                    words.forEach(word => {
                        if (!word.trim()) {
                            result += word;
                            return;
                        }
                        
                        // Comments within lines
                        if (word.includes('#')) {
                            result += `<span style="color: #6a9955; font-style: italic;">${word}</span>`;
                        }
                        // Print and other output functions
                        else if (['print', 'input', 'display', 'show'].includes(word)) {
                            result += `<span style="color: #d73a49; font-weight: bold;">${word}</span>`;
                        }
                        // Method calls and attribute access
                        else if (word.includes('.') && !word.startsWith('.') && !word.endsWith('.')) {
                            const parts = word.split('.');
                            let coloredParts = [];
                            
                            parts.forEach((part, index) => {
                                if (index === 0) {
                                    // Object names - DataFrames and common data structures
                                    if (['df', 'data', 'dataset', 'dataframe', 'DataFrame', 'Series', 'series', 
                                         'matrix', 'array', 'Array', 'ndarray', 'tensor', 'Tensor',
                                         'malaria_data', 'cases_df', 'stats_df', 'results_df',
                                         'clean_data', 'raw_data', 'processed_data', 'filtered_data',
                                         'merged_data', 'grouped_data', 'analysis_df'].includes(part)) {
                                        coloredParts.push(`<span style="color: #0366d6; font-weight: bold;">${part}</span>`);
                                    }
                                    // Library/module names
                                    else if (['pandas', 'pd', 'numpy', 'np', 'matplotlib', 'plt', 
                                             'seaborn', 'sns', 'plotly', 'px', 'sklearn', 'tf'].includes(part)) {
                                        coloredParts.push(`<span style="color: #e36209; font-weight: bold;">${part}</span>`);
                                    } else {
                                        coloredParts.push(part);
                                    }
                                } else {
                                    // Methods and attributes
                                    coloredParts.push(`<span style="color: #6f42c1; font-weight: bold;">${part}</span>`);
                                }
                            });
                            
                            result += coloredParts.join('.');
                        }
                        // Python keywords
                        else if (['import', 'from', 'as', 'def', 'class', 'return', 'if', 'else', 'elif',
                                 'for', 'while', 'try', 'except', 'finally', 'with', 'in', 'and', 'or', 'not',
                                 'is', 'lambda', 'yield', 'break', 'continue', 'pass', 'raise', 'assert',
                                 'del', 'global', 'nonlocal', 'async', 'await'].includes(word)) {
                            result += `<span style="color: #c678dd; font-weight: bold;">${word}</span>`;
                        }
                        // Libraries and packages
                        else if (['pandas', 'pd', 'numpy', 'np', 'matplotlib', 'plt', 'seaborn', 'sns',
                                 'plotly', 'px', 'scipy', 'sp', 'sklearn', 'tensorflow', 'tf',
                                 'requests', 'json', 'csv', 'os', 'sys', 'datetime', 'time'].includes(word)) {
                            result += `<span style="color: #e36209; font-weight: bold;">${word}</span>`;
                        }
                        // Data structures and variables
                        else if (['df', 'data', 'dataset', 'dataframe', 'DataFrame', 'Series', 'series',
                                 'matrix', 'array', 'Array', 'ndarray', 'tensor', 'Tensor',
                                 'malaria_data', 'cases_df', 'stats_df', 'results_df',
                                 'clean_data', 'raw_data', 'processed_data'].includes(word)) {
                            result += `<span style="color: #0366d6; font-weight: bold;">${word}</span>`;
                        }
                        // Built-in functions
                        else if (['len', 'str', 'int', 'float', 'bool', 'list', 'dict', 'tuple', 'set',
                                 'type', 'range', 'enumerate', 'zip', 'map', 'filter', 'sorted', 'reversed',
                                 'sum', 'min', 'max', 'abs', 'round', 'open', 'file'].includes(word)) {
                            result += `<span style="color: #e5c07b; font-weight: bold;">${word}</span>`;
                        }
                        // Constants and special values
                        else if (['True', 'False', 'None', 'self', 'cls'].includes(word)) {
                            result += `<span style="color: #e06c75; font-weight: bold;">${word}</span>`;
                        }
                        // String literals (basic detection)
                        else if ((word.startsWith('&quot;') && word.endsWith('&quot;')) || 
                                (word.startsWith('&#39;') && word.endsWith('&#39;'))) {
                            result += `<span style="color: #98c379;">${word}</span>`;
                        }
                        // Numbers
                        else if (/^\d+(\.\d+)?$/.test(word)) {
                            result += `<span style="color: #61afef; font-weight: bold;">${word}</span>`;
                        }
                        // Operators
                        else if (['=', '==', '!=', '&lt;', '&gt;', '&lt;=', '&gt;=', '+', '-', '*', '/', '//', '%', '**'].includes(word)) {
                            result += `<span style="color: #ff79c6; font-weight: bold;">${word}</span>`;
                        }
                        // Default case
                        else {
                            result += word;
                        }
                    });
                }
                
                // Add line break except for last line
                if (lineIndex < lines.length - 1) {
                    result += '\n';
                }
            });
            
            return result;
        }

        // Initialize the page with dynamic configuration
        document.addEventListener('DOMContentLoaded', async function() {
            // Load tab configuration first
            await loadTabConfiguration();
            
            // Set navigation as collapsed by default
            var tabNav = document.getElementById("tabNavigation");
            var toggleBtn = document.getElementById("tabToggleBtn");
            
            if (tabNav && toggleBtn) {
                tabNav.classList.remove("expanded");
                toggleBtn.classList.add("collapsed");
            }
            
            // Initialize all content sections as collapsed by default
            var sections = document.querySelectorAll('.section-content');
            var buttons = document.querySelectorAll('.section-toggle');
            
            sections.forEach(function(section) {
                if (section) section.classList.remove('expanded');
            });
            
            buttons.forEach(function(button) {
                if (button) button.classList.add('collapsed');
            });

            // Apply syntax highlighting to existing code content
            applyGlobalSyntaxHighlighting();
        });

        function applyGlobalSyntaxHighlighting() {
            const allCodeElements = document.querySelectorAll('.code-content');
            
            allCodeElements.forEach(element => {
                if (!element.innerHTML.includes('style="color:')) {
                    const originalCode = element.textContent;
                    const coloredCode = formatCodeBlock(originalCode, 'python');
                    element.innerHTML = coloredCode;
                }
            });
        }
    </script>
</body>
</html>
